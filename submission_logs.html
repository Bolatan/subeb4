<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Submission Logs</title>
    <style>
        /* Basic styles from index.html */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --lagos-red: #DC2626; --lagos-blue: #1E40AF; --lagos-yellow: #FACC15;
            --lagos-green: #16A34A; --lagos-white: #FFFFFF; --lagos-navy: #1E3A8A;
            --lagos-dark-gray: #64748B;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--lagos-blue); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; min-height: 100vh; }
        .header { background: var(--lagos-navy); border-radius: 15px; padding: 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; color: var(--lagos-white); position: relative; border-left: 8px solid var(--lagos-red); }
        .header .logo { display: flex; align-items: center; font-size: 24px; font-weight: bold; color: var(--lagos-white); }
        .header .logo img { height: 40px; width: 40px; margin-right: 12px; }
        .btn, .btn-secondary { background: var(--lagos-green); border-color: var(--lagos-yellow); color: var(--lagos-white); text-decoration: none; padding: 8px 16px; border-radius: 10px; border: 1px solid transparent; cursor: pointer; }
        .content-area { background: var(--lagos-white); border-radius: 15px; padding: 30px; overflow-y: auto; }
        .data-table { width: 100%; border-collapse: collapse; background: var(--lagos-white); border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .data-table th { background: var(--lagos-blue); color: var(--lagos-white); font-weight: 600; }
        .data-table tr:nth-child(even) { background-color: #f8f9fa; }
        .data-table tr:hover { background-color: #e9ecef; }
        #loadingMessage { text-align: center; padding: 20px; font-size: 1.2em; color: var(--lagos-navy); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 15px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <img src="subeb.jpg" alt="Lagos State Logo">
                <span>Survey Submission Logs</span>
            </div>
            <div>
                <button id="exportExcelBtn" class="btn" style="display: none; margin-right: 10px;">Export to Excel</button>
                <button id="exportPdfBtn" class="btn" style="display: none; margin-right: 10px;">Export to PDF</button>
                <a href="index.html" class="btn-secondary">Back to Home</a>
            </div>
        </div>
        <div class="content-area">
            <h2>Survey Submission Logs</h2>
            <table class="data-table" id="submissionsTable">
                <thead>
                    <tr>
                        <th>Survey Type</th>
                        <th>Submission Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Submission data will be inserted here -->
                </tbody>
            </table>
            <div id="loadingMessage">Loading submissions...</div>
        </div>
    </div>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Submission Details</h3>
            <div id="modal-data" style="word-wrap: break-word; white-space: pre-wrap;"></div>
        </div>
    </div>

    <script>
        // Global variable to hold submission data
        let allSubmissions = [];

        document.addEventListener('DOMContentLoaded', function() {
            fetchSubmissions();
            setupModal();
            // Add event listeners for export buttons
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);
        });

        async function fetchSubmissions() {
            const tableBody = document.querySelector('#submissionsTable tbody');
            const loadingMessage = document.getElementById('loadingMessage');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');

            loadingMessage.style.display = 'block';
            exportExcelBtn.style.display = 'none';
            exportPdfBtn.style.display = 'none';

            try {
                const user = JSON.parse(localStorage.getItem('auditAppCurrentUser'));
                if (!user || !user.token) {
                    loadingMessage.innerHTML = '<strong>Authentication required.</strong><br>Please log in to view this content.';
                    return;
                }

                const response = await fetch('/api/reports/all', {
                    headers: {
                        'Authorization': `Bearer ${user.token}`
                    }
                });

                if (response.status === 401) {
                    loadingMessage.innerHTML = '<strong>Access Denied.</strong><br>You do not have permission to view this page.';
                    throw new Error('Access Denied');
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const submissions = await response.json();
                allSubmissions = submissions; // Store data globally
                loadingMessage.style.display = 'none';
                tableBody.innerHTML = '';

                if (submissions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px;">No submissions found.</td></tr>';
                    return;
                }

                // Show export buttons if there is data
                exportExcelBtn.style.display = 'inline-block';
                exportPdfBtn.style.display = 'inline-block';

                submissions.forEach(submission => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${submission.surveyType}</td>
                        <td>${new Date(submission.createdAt).toLocaleString()}</td>
                        <td><button class="btn" onclick='viewDetails(${JSON.stringify(submission.formData)})'>View Details</button></td>
                    `;
                });
            } catch (error) {
                if (error.message !== 'Access Denied') {
                    loadingMessage.innerHTML = '<strong>Failed to load submissions.</strong>';
                }
                console.error('Error fetching submissions:', error);
            }
        }

        function exportWithToken(url) {
            const user = JSON.parse(localStorage.getItem('auditAppCurrentUser'));
            if (!user || !user.token) {
                alert('Authentication required. Please log in.');
                return;
            }
            // Append token to URL and trigger download
            window.location.href = `${url}?token=${user.token}`;
        }

        function exportToExcel() {
            if (allSubmissions.length === 0) {
                alert('No data to export.');
                return;
            }
            exportWithToken('/api/export/excel');
        }

        function exportToPdf() {
            if (allSubmissions.length === 0) {
                alert('No data to export.');
                return;
            }
            exportWithToken('/api/export/pdf');
        }

        function setupModal() {
            const modal = document.getElementById('detailsModal');
            const span = document.getElementsByClassName("close")[0];

            span.onclick = function() {
                modal.style.display = "none";
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        }

        function viewDetails(data) {
            const modal = document.getElementById('detailsModal');
            const dataContainer = document.getElementById('modal-data');

            const isImageUrl = (url) => {
                if (typeof url !== 'string') return false;
                // Robust check for image URLs or base64 data URIs
                return url.startsWith('data:image') || /\.(jpg|jpeg|png|gif|svg)$/i.test(url);
            };

            const buildHtml = (obj, indent = 0) => {
                let html = '';
                const indentation = '&nbsp;'.repeat(indent * 4);

                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        const value = obj[key];
                        html += `${indentation}<strong>${key}:</strong> `;

                        if (isImageUrl(value)) {
                            html += `<a href="${value}" target="_blank" download>Download Image</a><br>`;
                        } else if (Array.isArray(value)) {
                            html += '<br>' + buildHtml(value, indent + 1);
                        } else if (typeof value === 'object' && value !== null) {
                            html += '<br>' + buildHtml(value, indent + 1);
                        } else {
                            html += `${value}<br>`;
                        }
                    }
                }
                return html;
            };

            dataContainer.innerHTML = buildHtml(data);
            modal.style.display = "block";
        }
    </script>
</body>
</html>
